<html>
<head>
  <meta charset="utf-8"/>
  <script src="NameSpace.js" type="text/javascript" ></script>
  <script src="String.js" type="text/javascript"></script>
  <script src="Maths.js" type="text/javascript"></script>
  <script src="Maths.Coordinate.js" type="text/javascript"></script>
  <script src="Astronomy.js" type="text/javascript"></script>
  <script src="Astronomy.AxialPrecession.js" type="text/javascript"></script>
  <script src="Astronomy.Nutation.js" type="text/javascript"></script>
  <script src="Astronomy.Coordinate.js" type="text/javascript"></script>
  <script src="Astronomy.Atmosphere.js" type="text/javascript"></script>
  <script src="Astronomy.Constant.js" type="text/javascript"></script>
  <script src="Astronomy.Parallax.js" type="text/javascript"></script>
  <script src="Test.js" type="text/javascript"></script>
</head>
<body>
  <script>
      with(Calendar){
        Test.browser=window;
        Test.console=console;
        Test.println('模块测试',"h3");
        Test.println("Maths模块","h4");
        Test.test(
          "Maths.normalizeToRangePlusMinusPi(13.2π)",
          Maths.normalizeToRangePlusMinusPi(13.2*Maths.Pi),
          -0.8*Maths.Pi,
          10e-12,
          "10e-12"
        ).test(
          "Maths.normalizeToRangeZeroDoublePi(13.2π)",
          Maths.normalizeToRangeZeroDoublePi(13.2*Maths.Pi),
          1.2*Maths.Pi,
          10e-12,
          "10e-12"
        ).test(
          "Maths.parseAngle(\"7h 45m 18.946s\")",
          Maths.parseAngle("7h 45m 18.946s"),
          (7*3600+45*60+18.946)/180*Maths.Pi/3600*15,
          10e-12,
          "10e-12"
        );
        Test.println("Maths.Coordinate模块","h4");
        Test.println("","hr");
        Test.println("在球面坐标系，创建点(1,π,2π/3):");
        var point=new Maths.Coordinate.Sphere(1,Math.PI,2*Math.PI/3);
        Test.test(
          "Maths.Coordinate.Sphere(1,π,2π/3)",
          point,
          "r=1, θ="+Math.PI+", φ="+2*Math.PI/3,
          10e-12,
          "10e-12",
          function(){
            return Test.checkNumber(point.r,1,10e-12) && Test.checkNumber(point.theta, Math.PI,10e-12) && Test.checkNumber(point.phi,2*Math.PI/3,10e-12);
        });
        Test.println("","hr");
        Test.println("球面坐标(1,π,2π/3)转换为直角坐标：");
        var p=point.toRectangular();
        Test.test(
          "Maths.Coordinate.Sphere.toRectangular()",
          p,
          "x=0, y=0, z=-1",
          10e-12,
          "10e-12",
          function(){
            return Test.checkNumber(p.x,0,10e-12) && Test.checkNumber(p.y,0,10e-12) && Test.checkNumber(p.z,-1,10e-12);
        });
        Test.println("","hr");
        Test.println("已知球面坐标(1,π,2π/3)。按对应的直角坐标系下矢量(-1,0,-1)平移<b>坐标系</b>，然后将<b>坐标系</b>绕Z轴(0,0,1)逆时针旋转π/4，求新坐标")
        Test.println("","hr");
        Test.println("单个点采用链式写法，依次变换。");
        var p=point.translate(new Maths.Vector3(-1,0,-1)).rotateZ(Math.PI/4).transform();
        Test.test(
          "Maths.Coordinate.Sphere.translate(Maths.Vector3(-1,0,1)).rotateZ(π/4).transform()",
          p,
          "r=1, θ="+Math.PI/2+", φ="+(7*Math.PI/4),
          10e-12,
          "10e-12",
          function(){
            return Test.checkNumber(p.r,1,10e-12) && Test.checkNumber(p.theta,Math.PI/2,10e-12) && Test.checkNumber(p.phi,7*Math.PI/4,10e-12);
        });
        Test.println("","hr");
        Test.println("多个点采用TransformBuilder写法。先将多次变换合成一次变换，然后对每个点做一次变换即可。");
        var b=new Maths.Coordinate.Rectangular.TransformBuilder();
        b.add(new Maths.Coordinate.Rectangular.Translation(new Maths.Vector3(-1,0,-1)))
        .add(new Maths.Coordinate.Rectangular.Rotation(Math.PI/4,new Maths.Vector3(0,0,1)));
        var t=b.build();
        var p=point.transform(t).transform();
        Test.test(
          "Maths.Coordinate.Rectangular.TransformBuilder",
          p,
          "r=1, θ="+Math.PI/2+", φ="+7*Math.PI/4,
          10e-12,
          "10e-12",
          function(){
            return Test.checkNumber(p.r,1,10e-12) && Test.checkNumber(p.theta,Math.PI/2,10e-12) && Test.checkNumber(p.phi,7*Math.PI/4,10e-12);
        });
        Test.println("","hr");
        Test.println("计算(1,π/6,0)和(1,π/6,π)的夹角：")
        var p1=new Maths.Coordinate.Sphere(1,Math.PI/6,0);
        var p2=new Maths.Coordinate.Sphere(1,Math.PI/6,Math.PI);
        var res=p1.includedAngle(p2);
        Test.test(
          "Maths.Coordinate.Sphere.includedAngle",
          res,
          "π/3="+Math.PI/3,
          10e-12,
          "10e-12",
          function(){
            return Test.checkNumber(res,Math.PI/3,10e-12);
        });
        Test.println("","hr");
        Test.println("计算(1,0,0)和(1,π/10000,π)的夹角：")
        var p1=new Maths.Coordinate.Sphere(1,0,0);
        var p2=new Maths.Coordinate.Sphere(1,Math.PI/10000,Math.PI);
        var res=p1.includedAngle(p2);
        Test.test(
          "Maths.Coordinate.Sphere.includedAngle",
          res,
          "π/10000="+Math.PI/10000,
          10e-12,
          "10e-12",
          function(){
            return Test.checkNumber(res,Math.PI/10000,10e-12);
        });
        Test.println("Astronomy.Coordinate模块","h4");
        Test.println("","hr");
        Test.println("已知恒星Pollux(β Gem)的赤道坐标是：α2000 = 7h 45m 18s.946， δ2000 = +28.026183°。黄赤交角为ε=23.4392911°。<br/>求黄道坐标:[《天文算法》第12章例题]");
        var p=new Astronomy.Coordinate.Equator(Maths.parseAngle("7h 45m 18s.946"),Maths.parseAngle("+28.026183°"));
        var p1=p.toEcliptic(Maths.parseAngle("23.4392911°"));
        var err=Maths.parseAngle("0.01\"");
        Test.test(
          "Astronomy.Coordinate.Equator.toEcliptic",
          "λ="+Maths.formatRadian(p1.longitude,"d",6)+", β="+Maths.formatRadian(p1.latitude,"d",6),
          "λ=113°.215630，β = +6°.684170",
          err,
          "0.01\"",
          function(){
            return Test.checkNumber(Maths.parseAngle("113.215630°"),p1.longitude,err)
            && Test.checkNumber(Maths.parseAngle("+6.684170°"),p1.latitude,err);
          }
        );
        Test.println("","hr");
        Test.println("恒星ζPersei 在J2000.0 的历元平赤道坐标为：αo = 2h 44m 11s.986 δo = +49°13′42\".48  <br/> 该坐标中，它每年的自行速度是：+0s.03425 (赤经)-0\".0895 (赤纬)<br/>把该坐标转到2028 年11 月13.19 日TD 历元平坐标中。[《天文算法》第20章例题。基于IAU1976岁差模型]");
        var start=2451545.0;
        var end=2462088.69;
        var t=(end-start)/36525;
        var alpha=Maths.parseAngle("2h 44m 11s.986")+Maths.parseAngle("+0s.03425")*(end-start)/365.25;
        var delta=Maths.parseAngle("+49°13′42\".48")+Maths.parseAngle("-0\".0895")*(end-start)/365.25;

        var p=new Astronomy.Coordinate.Equator(alpha,delta);
        var p1= p.toMeanDateEqutator(t,"IAU1976");
        Test.test(
          "Astronomy.Coordinate.Equator.toMeanDateEqutator",
          "α="+Maths.formatRadian(p1.rightAscension,"hms",3)+", δ="+Maths.formatRadian(p1.declination,"dms"),
          "α = +41°.547214 = 2h 46m 11s.331，δ = +49°.348483 = +49°20′54\".54",
          err,
          "0.01\"",
          function(){
            return Test.checkNumber(Maths.parseAngle("+41°.547214"),p1.rightAscension,err)
            && Test.checkNumber(Maths.parseAngle("+49°.348483"),p1.declination,err);
          }
        );

        Test.println("","hr");
        Test.println("表面光滑的太阳圆盘下边沿视纬度是 30′，求下边沿真地平纬度。[《天文算法》第15章例题。节选]");

        var p=Maths.parseAngle("30'");
        var R=Atomsphere.Refraction(p);
        var err=Maths.parseAngle("0.015'");
        Test.test(
          "Astronomy.Atmosphere.Refraction",
          "Apparent altitude in Horizontal Coordinate System="+Maths.formatRadian(p+R,'_m'),
          "1'.246",
          err,
          "0.015'",
          function(){
            return Test.checkNumber(Maths.parseAngle("1'.246"),p+R,err);
          }
        );

        Test.println("","hr");
        Test.println("试计算2003 年 8 月 28 日 3h 17m 00s UT 时火星的赤经赤纬。");
        Test.println("由星历表，该时刻火星的赤经22h38m07s.25，赤纬-15°46'15\".9，距离0.37276AU。")
        Test.println("Palomar观测站位于西经+7h47m27s, 纬度+33°21′22\"，海拔高度1706米。")
        Test.println("该时刻的格林尼治恒星时+1h40m45s。[《天文算法》第10章，第39章例题。书上计算时角时仅保留了整数秒，所以程序在检验精度时误差允许1\"]");
        var p=new Astronomy.Coordinate.Equator(Maths.parseAngle("22h38m07s.25"),Maths.parseAngle("-15°46'15\".9"),0.37276*Astronomy.Constant.AU);
        var H=Maths.parseAngle("+1h40m45s")-Maths.parseAngle("+7h47m27s")-p.rightAscension;
        var p1=Astronomy.Parallax.correction(p,H,Maths.parseAngle("+33°21′22\""),1706);
        var err=Maths.parseAngle("1\"");
        Test.test(
          "Astronomy.Atmosphere.Parallax.correction",
          "α="+Maths.formatRadian(p1.rightAscension,"hms",3)+", δ="+Maths.formatRadian(p1.declination,"dms",3),
          "α=22h38m08s.54, δ=-15°46'30\".0",
          err,
          "1\"",
          function(){
             return Test.checkNumber(Maths.parseAngle("22h38m08s.54"),p1.rightAscension,err)
             && Test.checkNumber(Maths.parseAngle("-15°46'30\".0"),p1.declination,err);
          }
        );
        var arr=[22639.5858800,  2.3555545723,  8328.6914247251, 1.5231275E-04, 2.5041111E-07,-1.1863391E-09, 4586.4383203,  8.0413790709,  7214.0628654588,-2.1850087E-04,-1.8646419E-07, 8.7760973E-10, 2369.9139357, 10.3969336431, 15542.7542901840,-6.6188121E-05, 6.3946925E-08,-3.0872935E-10,  769.0257187,  4.7111091445, 16657.3828494503, 3.0462550E-04, 5.0082223E-07,-2.3726782E-09,
         -666.4175399, -0.0431256817,   628.3019552485,-2.6638815E-06, 6.1639211E-10,-5.4439728E-11, -411.5957339,  3.2558104895, 16866.9323152810,-1.2804259E-04,-9.8998954E-09, 4.0433461E-11,  211.6555524,  5.6858244986, -1114.6285592663,-3.7081362E-04,-4.3687530E-07, 2.0639488E-09,  205.4359530,  8.0845047526,  6585.7609102104,-2.1583699E-04,-1.8708058E-07, 9.3204945E-10,
          191.9561973, 12.7524882154, 23871.4457149091, 8.6124629E-05, 3.1435804E-07,-1.4950684E-09,  164.7286185, 10.4400593249, 14914.4523349355,-6.3524240E-05, 6.3330532E-08,-2.5428962E-10, -147.3213842, -2.3986802540, -7700.3894694766,-1.5497663E-04,-2.4979472E-07, 1.1318993E-09, -124.9881185,  5.1984668216,  7771.3771450920,-3.3094061E-05, 3.1973462E-08,-1.5436468E-10,
         -109.3803637,  2.3124288905,  8956.9933799736, 1.4964887E-04, 2.5102751E-07,-1.2407788E-09,   55.1770578,  7.1411231536, -1324.1780250970, 6.1854469E-05, 7.3846820E-08,-3.4916281E-10,  -45.0996092,  5.6113650618, 25195.6237400061, 2.4270161E-05, 2.4051122E-07,-1.1459056E-09,   39.5333010, -0.9002559173, -8538.2408905558, 2.8035534E-04, 2.6031101E-07,-1.2267725E-09,
           38.4298346, 18.4383127140, 22756.8171556428,-2.8468899E-04,-1.2251727E-07, 5.6888037E-10,   36.1238141,  7.0666637168, 24986.0742741754, 4.5693825E-04, 7.5123334E-07,-3.5590172E-09,   30.7725751, 16.0827581417, 14428.1257309177,-4.3700174E-04,-3.7292838E-07, 1.7552195E-09,  -28.3971008,  7.9982533891,  7842.3648207073,-2.2116475E-04,-1.8584780E-07, 8.2317000E-10,
          -24.3582283, 10.3538079614, 16171.0562454324,-6.8852003E-05, 6.4563317E-08,-3.6316908E-10,  -18.5847068,  2.8429122493,  -557.3142796331,-1.8540681E-04,-2.1843765E-07, 1.0319744E-09,   17.9544674,  5.1553411398,  8399.6791003405,-3.5757942E-05, 3.2589854E-08,-2.0880440E-10,   14.5302779, 12.7956138971, 23243.1437596606, 8.8788511E-05, 3.1374165E-07,-1.4406287E-09,
           14.3796974, 15.1080427876, 32200.1371396342, 2.3843738E-04, 5.6476915E-07,-2.6814075E-09,   14.2514576,-24.0810366320,    -2.3011998397, 1.5231275E-04, 2.5041111E-07,-1.1863391E-09,   13.8990596, 20.7938672862, 31085.5085803679,-1.3237624E-04, 1.2789385E-07,-6.1745870E-10,   13.1940636,  3.3302699264, -9443.3199839914,-5.2312637E-04,-6.8728642E-07, 3.2502879E-09,
           -9.6790568, -4.7542348263,-16029.0808942018,-3.0728938E-04,-5.0020584E-07, 2.3182384E-09,   -9.3658635, 11.2971895604, 24080.9951807398,-3.4654346E-04,-1.9636409E-07, 9.1804319E-10,    8.6055318,  5.7289501804, -1742.9305145148,-3.6814974E-04,-4.3749170E-07, 2.1183885E-09,   -8.4530982,  7.5540213938, 16100.0685698171, 1.1921869E-04, 2.8238458E-07,-1.3407038E-09,
            8.0501724, 10.4831850066, 14286.1503796870,-6.0860358E-05, 6.2714140E-08,-1.9984990E-10,   -7.6301553,  4.6679834628, 17285.6848046987, 3.0196162E-04, 5.0143862E-07,-2.4271179E-09,   -7.4474952, -0.0862513635,  1256.6039104970,-5.3277630E-06, 1.2327842E-09,-1.0887946E-10,    7.3712011,  8.1276304344,  5957.4589549619,-2.1317311E-04,-1.8769697E-07, 9.8648918E-10,
            7.0629900,  0.9591375719,    33.7570471374,-3.0829302E-05,-3.6967043E-08, 1.7385419E-10,   -6.3831491,  9.4966777258,  7004.5133996281, 2.1416722E-04, 3.2425793E-07,-1.5355019E-09,   -5.7416071, 13.6527441326, 32409.6866054649,-1.9423071E-04, 5.4047029E-08,-2.6829589E-10,    4.3740095, 18.4814383957, 22128.5152003943,-2.8202511E-04,-1.2313366E-07, 6.2332010E-10,
           -3.9976134,  7.9669196340, 33524.3151647312, 1.7658291E-04, 4.9092233E-07,-2.3322447E-09,   -3.2096876, 13.2398458924, 14985.4400105508,-2.5159493E-04,-1.5449073E-07, 7.2324505E-10,   -2.9145404, 12.7093625336, 24499.7476701576, 8.3460748E-05, 3.1497443E-07,-1.5495082E-09,    2.7318890, 16.1258838235, 13799.8237756692,-4.3433786E-04,-3.7354477E-07, 1.8096592E-09,
           -2.5679459, -2.4418059357, -7072.0875142282,-1.5764051E-04,-2.4917833E-07, 1.0774596E-09,   -2.5211990,  7.9551277074,  8470.6667759558,-2.2382863E-04,-1.8523141E-07, 7.6873027E-10,    2.4888871,  5.6426988169,  -486.3266040178,-3.7347750E-04,-4.3625891E-07, 2.0095091E-09,    2.1460741,  7.1842488353, -1952.4799803455, 6.4518350E-05, 7.3230428E-08,-2.9472308E-10,
            1.9777270, 23.1494218585, 39414.2000050930, 1.9936508E-05, 3.7830496E-07,-1.8037978E-09,    1.9336825,  9.4222182890, 33314.7656989005, 6.0925100E-04, 1.0016445E-06,-4.7453563E-09,    1.8707647, 20.8369929680, 30457.2066251194,-1.2971236E-04, 1.2727746E-07,-5.6301898E-10,   -1.7529659,  0.4873576771, -8886.0057043583,-3.3771956E-04,-4.6884877E-07, 2.2183135E-09,
           -1.4371624,  7.0979974718,  -695.8760698485, 5.9190587E-05, 7.4463212E-08,-4.0360254E-10,   -1.3725701,  1.4552986550,  -209.5494658307, 4.3266809E-04, 5.1072212E-07,-2.4131116E-09,    1.2618162,  7.5108957121, 16728.3705250656, 1.1655481E-04, 2.8300097E-07,-1.3951435E-09
       ];
        Test.println("[");
        for(var i=0;i<arr.length;i+=6){
          Test.println("["+arr[i]+","+arr[i+1]+","+arr[i+2]+","+arr[i+3]+","+arr[i+4]+","+arr[i+5]+"],");
        }
        Test.println("]");
      }

  </script>
</body>
</html>
